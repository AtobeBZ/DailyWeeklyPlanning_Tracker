<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Clock Planner - Light</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #fefaf6;
            --bg-secondary: #fff8f0;
            --bg-tertiary: #fff1e6;
            --text-primary: #4a3728;
            --text-secondary: #8b7355;
            --accent: #e07b4c;
            --accent-hover: #c9663a;
            --border: #e8d5c4;
            
            --cat-work: #e74c3c;
            --cat-family: #27ae60;
            --cat-admin: #f39c12;
            --cat-myself: #16a085;
            --cat-goal1: #9b59b6;
            --cat-goal2: #e91e63;
            --cat-goal3: #3498db;
            --cat-else: #7f8c8d;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            letter-spacing: 2px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--accent), #d4a574);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Main View Toggle */
        .main-view-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
        }

        .main-view-toggle .toggle-container {
            display: flex;
            gap: 4px;
            background: var(--bg-secondary);
            padding: 6px;
            border-radius: 14px;
            box-shadow: 0 2px 12px rgba(139, 115, 85, 0.12);
        }

        .main-view-btn {
            padding: 12px 28px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .main-view-btn.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 8px rgba(224, 123, 76, 0.3);
        }

        .main-view-btn:hover:not(.active) {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .main-view-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Daily View Styles */
        .daily-view {
            display: none;
        }

        .daily-view.active {
            display: block;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 30px;
        }

        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Control Bar */
        .control-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
        }

        .day-type-selector {
            display: flex;
            gap: 8px;
            background: var(--bg-secondary);
            padding: 6px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(139, 115, 85, 0.1);
        }

        .day-type-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .day-type-btn.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 8px rgba(224, 123, 76, 0.3);
        }

        .day-type-btn:hover:not(.active) {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .view-toggle {
            display: flex;
            gap: 8px;
            background: var(--bg-secondary);
            padding: 6px;
            border-radius: 12px;
            margin-left: auto;
            box-shadow: 0 2px 8px rgba(139, 115, 85, 0.1);
        }

        .view-btn {
            padding: 10px 18px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .view-btn.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Clock Section */
        .clock-section {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(139, 115, 85, 0.1);
        }

        .clocks-container {
            display: flex;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
        }

        .clock-wrapper {
            text-align: center;
        }

        .clock-label {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-weight: 500;
        }

        .clock {
            position: relative;
            width: 320px;
            height: 320px;
        }

        .clock svg {
            width: 100%;
            height: 100%;
        }

        .clock-face {
            fill: #fff5eb;
            stroke: var(--border);
            stroke-width: 2;
        }

        .clock-center {
            fill: var(--bg-secondary);
        }

        .hour-marker {
            stroke: #d4b8a0;
            stroke-width: 2;
        }

        .hour-text {
            fill: var(--text-secondary);
            font-size: 11px;
            font-weight: 500;
        }

        .activity-arc {
            cursor: pointer;
            transition: opacity 0.2s, filter 0.2s;
        }

        .activity-arc:hover {
            filter: brightness(1.1);
        }

        /* Legend */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Summary Stats */
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 10px;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Side Panel */
        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(139, 115, 85, 0.1);
        }

        .panel-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
        }

        .panel-title svg {
            width: 18px;
            height: 18px;
            stroke: var(--accent);
        }

        /* Activity Form */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            width: 100%;
            box-shadow: 0 2px 8px rgba(224, 123, 76, 0.3);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        /* Activities List */
        .activities-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .activities-list::-webkit-scrollbar {
            width: 6px;
        }

        .activities-list::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        .activities-list::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin-bottom: 8px;
            transition: transform 0.2s;
            border: 1px solid transparent;
        }

        .activity-item:hover {
            transform: translateX(4px);
            border-color: var(--border);
        }

        .activity-color {
            width: 8px;
            height: 40px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .activity-info {
            flex: 1;
            min-width: 0;
        }

        .activity-name {
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .activity-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .activity-actions {
            display: flex;
            gap: 6px;
        }

        .activity-actions button {
            width: 28px;
            height: 28px;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .activity-actions button:hover {
            background: var(--accent);
            color: white;
        }

        .activity-actions button.delete:hover {
            background: #e74c3c;
        }

        .activity-actions button.edit:hover {
            background: var(--accent);
        }

        .activity-item.editing {
            border-color: var(--accent);
            background: linear-gradient(135deg, var(--bg-tertiary), #fff5eb);
            box-shadow: 0 0 0 2px rgba(224, 123, 76, 0.2);
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            stroke: var(--border);
            margin-bottom: 12px;
        }

        /* Export/Import Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            background: white;
            border: 1px solid var(--border);
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(139, 115, 85, 0.2);
            max-width: 220px;
        }

        .tooltip-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .tooltip-time {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .tooltip-category {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-top: 6px;
        }

        .tooltip-day {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
            padding-top: 4px;
            border-top: 1px solid var(--border);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(74, 55, 40, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            transform: scale(0.9);
            transition: transform 0.3s;
            box-shadow: 0 20px 60px rgba(139, 115, 85, 0.3);
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--border);
            color: var(--text-primary);
        }

        /* Day Type Management */
        .day-type-list {
            margin-bottom: 15px;
        }

        .day-type-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .day-type-item span {
            font-size: 0.9rem;
        }

        .new-day-type-input {
            display: flex;
            gap: 10px;
        }

        .new-day-type-input input {
            flex: 1;
        }

        /* Color Input Wrapper */
        .color-input-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .color-input-wrapper input[type="color"] {
            width: 50px;
            height: 38px;
            padding: 2px;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            background: var(--bg-tertiary);
        }

        .color-input-wrapper input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 2px;
        }

        .color-input-wrapper input[type="color"]::-webkit-color-swatch {
            border-radius: 4px;
            border: none;
        }

        .btn-reset-color {
            padding: 6px 12px;
            font-size: 0.8rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-reset-color:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* Category Colors Modal */
        .category-colors-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .category-color-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .category-color-item input[type="color"] {
            width: 40px;
            height: 32px;
            padding: 2px;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            background: var(--bg-secondary);
        }

        .category-color-item input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 2px;
        }

        .category-color-item input[type="color"]::-webkit-color-swatch {
            border-radius: 3px;
            border: none;
        }

        .category-color-item span {
            flex: 1;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        /* ==================== WEEKLY VIEW STYLES ==================== */
        .weekly-view {
            display: none;
        }

        .weekly-view.active {
            display: block;
        }

        .weekly-container {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(139, 115, 85, 0.1);
            overflow-x: auto;
        }

        .weekly-grid {
            display: grid;
            grid-template-columns: 50px repeat(7, 1fr);
            min-width: 900px;
            gap: 0;
        }

        /* Time column */
        .time-column {
            display: flex;
            flex-direction: column;
        }

        .time-column-header {
            height: 80px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 10px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .time-slot {
            height: 40px;
            display: flex;
            align-items: flex-start;
            justify-content: flex-end;
            padding-right: 10px;
            font-size: 0.7rem;
            color: var(--text-secondary);
            transform: translateY(-8px);
        }

        /* Day columns */
        .day-column {
            border-left: 1px solid var(--border);
            min-width: 120px;
        }

        .day-column-header {
            height: 80px;
            padding: 10px;
            text-align: center;
            border-bottom: 2px solid var(--border);
            background: var(--bg-tertiary);
        }

        .day-column-header:first-of-type {
            border-top-left-radius: 12px;
        }

        .day-column:last-child .day-column-header {
            border-top-right-radius: 12px;
        }

        .day-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .day-type-select {
            width: 100%;
            padding: 6px 8px;
            font-size: 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
        }

        .day-type-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .day-slots {
            position: relative;
            height: calc(24 * 40px);
        }

        .hour-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--border);
        }

        .half-hour-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--border);
            opacity: 0.4;
        }

        .weekly-activity {
            position: absolute;
            left: 4px;
            right: 4px;
            border-radius: 6px;
            padding: 4px 6px;
            font-size: 0.7rem;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 1;
        }

        .weekly-activity:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10;
        }

        .weekly-activity-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .weekly-activity-time {
            font-size: 0.65rem;
            opacity: 0.9;
            color: white;
            margin-top: 2px;
        }

        /* Weekly Legend */
        .weekly-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        /* Weekly Stats */
        .weekly-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .weekly-stat-item {
            text-align: center;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 12px;
        }

        .weekly-stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .weekly-stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Weekend styling */
        .day-column.weekend .day-column-header {
            background: linear-gradient(135deg, #fff1e6, #ffe8d6);
        }

        .day-column.weekend .day-name {
            color: var(--accent);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .activity-item {
            animation: fadeIn 0.3s ease;
        }

        .weekly-activity {
            animation: fadeIn 0.2s ease;
        }

        /* Responsive */
        @media (max-width: 1000px) {
            .weekly-grid {
                min-width: 800px;
            }
            
            .day-column {
                min-width: 100px;
            }
        }

        /* Charts Section */
        .charts-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid var(--border);
        }

        .charts-row {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .charts-row:last-child {
            grid-template-columns: 1fr;
        }

        .chart-card {
            background: var(--bg-tertiary);
            border-radius: 16px;
            padding: 20px;
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 280px;
        }

        .chart-container.donut-container {
            height: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-container.bar-container {
            height: 320px;
        }

        @media (max-width: 900px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<body>
    <div class="container">
        <header>
            <h1>Daily Clock Planner</h1>
            <p>Visualize and optimize your daily time allocation</p>
        </header>

        <!-- Main View Toggle -->
        <div class="main-view-toggle">
            <div class="toggle-container">
                <button class="main-view-btn active" data-mainview="daily" onclick="setMainView('daily')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    Daily View
                </button>
                <button class="main-view-btn" data-mainview="weekly" onclick="setMainView('weekly')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    Weekly View
                </button>
            </div>
        </div>

        <!-- ==================== DAILY VIEW ==================== -->
        <div class="daily-view active" id="dailyView">
            <div class="control-bar">
                <div class="day-type-selector" id="dayTypeSelector"></div>
                <button class="btn btn-secondary btn-sm" onclick="openDayTypeModal()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                    Manage Day Types
                </button>
                <button class="btn btn-secondary btn-sm" onclick="openCategoryColorsModal()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <circle cx="12" cy="12" r="4"/>
                        <line x1="12" y1="2" x2="12" y2="6"/>
                        <line x1="12" y1="18" x2="12" y2="22"/>
                        <line x1="2" y1="12" x2="6" y2="12"/>
                        <line x1="18" y1="12" x2="22" y2="12"/>
                    </svg>
                    Category Colors
                </button>
                <div class="view-toggle">
                    <button class="view-btn active" data-view="activities" onclick="setView('activities')">Activities</button>
                    <button class="view-btn" data-view="categories" onclick="setView('categories')">Categories</button>
                </div>
            </div>

            <div class="main-layout">
                <div class="clock-section">
                    <div class="clocks-container">
                        <div class="clock-wrapper">
                            <div class="clock-label">AM (00:00 - 12:00)</div>
                            <div class="clock" id="clockAM"></div>
                        </div>
                        <div class="clock-wrapper">
                            <div class="clock-label">PM (12:00 - 24:00)</div>
                            <div class="clock" id="clockPM"></div>
                        </div>
                    </div>
                    <div class="legend" id="legend"></div>
                    <div class="summary-stats" id="summaryStats"></div>
                </div>

                <div class="side-panel">
                    <div class="panel-card">
                        <h3 class="panel-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                            Add Activity
                        </h3>
                        <form id="activityForm" onsubmit="addActivity(event)">
                            <div class="form-group">
                                <label for="activityName">Activity Name</label>
                                <input type="text" id="activityName" placeholder="e.g., Morning Routine" required>
                            </div>
                            <div class="form-group">
                                <label>Time Range</label>
                                <div class="time-inputs">
                                    <input type="time" id="startTime" required>
                                    <input type="time" id="endTime" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="category">Category</label>
                                <select id="category" required onchange="updateColorFromCategory()">
                                    <option value="work">Work</option>
                                    <option value="family">Family</option>
                                    <option value="admin">Admin</option>
                                    <option value="myself">Myself</option>
                                    <option value="goal1">Goal 1</option>
                                    <option value="goal2">Goal 2</option>
                                    <option value="goal3">Goal 3</option>
                                    <option value="else">Else</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="activityColor">Color</label>
                                <div class="color-input-wrapper">
                                    <input type="color" id="activityColor" value="#e07b4c">
                                    <button type="button" class="btn-reset-color" onclick="resetToCategory()" title="Reset to category color">Reset</button>
                                </div>
                            </div>
                            <button type="submit" id="submitBtn" class="btn btn-primary">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 5v14M5 12h14"/>
                                </svg>
                                Add Activity
                            </button>
                            <button type="button" id="cancelEditBtn" class="btn btn-secondary" style="display: none; margin-top: 10px;" onclick="cancelEdit()">
                                Cancel Edit
                            </button>
                        </form>
                    </div>

                    <div class="panel-card">
                        <h3 class="panel-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/>
                                <rect x="9" y="3" width="6" height="4" rx="1"/>
                            </svg>
                            Activities
                        </h3>
                        <div class="activities-list" id="activitiesList"></div>
                    </div>

                    <div class="panel-card">
                        <h3 class="panel-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                            </svg>
                            Save & Export
                        </h3>
                        <div class="action-buttons">
                            <button class="btn btn-secondary" onclick="saveToStorage()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                                    <path d="M17 21v-8H7v8M7 3v5h8"/>
                                </svg>
                                Save
                            </button>
                            <button class="btn btn-secondary" onclick="exportData()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                                </svg>
                                Export
                            </button>
                        </div>
                        <div class="action-buttons" style="margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="document.getElementById('importInput').click()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                                </svg>
                                Import
                            </button>
                            <button class="btn btn-danger" onclick="clearCurrentDay()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                </svg>
                                Clear
                            </button>
                        </div>
                        <div class="action-buttons" style="margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="loadExampleData()" style="grid-column: 1 / -1;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                                    <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                                </svg>
                                Load Example Week
                            </button>
                        </div>
                        <input type="file" id="importInput" accept=".json" style="display: none;" onchange="importData(event)">
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== WEEKLY VIEW ==================== -->
        <div class="weekly-view" id="weeklyView">
            <div class="weekly-container">
                <div class="weekly-grid" id="weeklyGrid"></div>
                <div class="weekly-legend" id="weeklyLegend"></div>
                <div class="weekly-stats" id="weeklyStats"></div>
                
                <!-- Charts Section -->
                <div class="charts-section">
                    <div class="charts-row">
                        <div class="chart-card">
                            <h3 class="chart-title">Weekly Time Distribution by Category</h3>
                            <div class="chart-container">
                                <canvas id="areaChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3 class="chart-title">Weekly Summary</h3>
                            <div class="chart-container donut-container">
                                <canvas id="donutChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="charts-row">
                        <div class="chart-card full-width">
                            <h3 class="chart-title">Comparison by Day Type Template</h3>
                            <div class="chart-container bar-container">
                                <canvas id="barChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip" style="display: none;"></div>

    <!-- Day Type Modal -->
    <div class="modal-overlay" id="dayTypeModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Manage Day Types</h3>
                <button class="modal-close" onclick="closeDayTypeModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="day-type-list" id="dayTypeList"></div>
            <div class="new-day-type-input">
                <input type="text" id="newDayTypeName" placeholder="New day type name...">
                <button class="btn btn-primary" onclick="addDayType()">Add</button>
            </div>
        </div>
    </div>

    <!-- Category Colors Modal -->
    <div class="modal-overlay" id="categoryColorsModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Customize Category Colors</h3>
                <button class="modal-close" onclick="closeCategoryColorsModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="category-colors-list" id="categoryColorsList"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="resetCategoryColors()">Reset to Defaults</button>
            </div>
        </div>
    </div>

    <script>
        const defaultCategoryColors = {
            work: '#e74c3c',
            family: '#27ae60',
            admin: '#f39c12',
            myself: '#16a085',
            goal1: '#9b59b6',
            goal2: '#e91e63',
            goal3: '#3498db',
            else: '#7f8c8d'
        };

        const categoryLabels = {
            work: 'Work',
            family: 'Family',
            admin: 'Admin',
            myself: 'Myself',
            goal1: 'Goal 1',
            goal2: 'Goal 2',
            goal3: 'Goal 3',
            else: 'Else'
        };

        function getCategoryColor(cat) {
            return (state.categoryColors && state.categoryColors[cat]) || defaultCategoryColors[cat];
        }

        function getCategories() {
            const cats = {};
            Object.keys(categoryLabels).forEach(key => {
                cats[key] = {
                    color: getCategoryColor(key),
                    label: categoryLabels[key]
                };
            });
            return cats;
        }

        let categories = null;

        function updateCategories() {
            categories = getCategories();
        }

        const weekDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

        let state = {
            dayTypes: ['Work Day', 'Off Day', 'Holiday'],
            currentDayType: 'Work Day',
            currentView: 'activities',
            currentMainView: 'daily',
            activities: { 'Work Day': [], 'Off Day': [], 'Holiday': [] },
            weekAssignments: {
                'Monday': 'Work Day', 'Tuesday': 'Work Day', 'Wednesday': 'Work Day',
                'Thursday': 'Work Day', 'Friday': 'Work Day', 'Saturday': 'Off Day', 'Sunday': 'Off Day'
            },
            categoryColors: { ...defaultCategoryColors }
        };

        function initExampleData() {
            const saved = localStorage.getItem('dailyPlannerStateLight');
            if (saved) {
                state = JSON.parse(saved);
                if (!state.weekAssignments) {
                    state.weekAssignments = {
                        'Monday': 'Work Day', 'Tuesday': 'Work Day', 'Wednesday': 'Work Day',
                        'Thursday': 'Work Day', 'Friday': 'Work Day', 'Saturday': 'Off Day', 'Sunday': 'Off Day'
                    };
                }
                if (!state.categoryColors) {
                    state.categoryColors = { ...defaultCategoryColors };
                }
                updateCategories();
                return;
            }

            // No saved data - load example data for new users
            state.categoryColors = { ...defaultCategoryColors };
            state.weekAssignments = {
                'Monday': 'Work Day', 'Tuesday': 'Work Day', 'Wednesday': 'Work Day',
                'Thursday': 'Work Day', 'Friday': 'Work Day', 'Saturday': 'Off Day', 'Sunday': 'Off Day'
            };

            // Example Work Day
            state.activities['Work Day'] = [
                { id: 1, name: 'Sleep', startTime: '22:30', endTime: '06:30', category: 'myself' },
                { id: 2, name: 'Morning Routine', startTime: '06:30', endTime: '07:15', category: 'myself' },
                { id: 3, name: 'Breakfast with Family', startTime: '07:15', endTime: '07:45', category: 'family' },
                { id: 4, name: 'Commute', startTime: '07:45', endTime: '08:30', category: 'else' },
                { id: 5, name: 'Deep Work Block', startTime: '08:30', endTime: '12:00', category: 'work' },
                { id: 6, name: 'Lunch Break', startTime: '12:00', endTime: '13:00', category: 'myself' },
                { id: 7, name: 'Meetings & Collaboration', startTime: '13:00', endTime: '15:00', category: 'work' },
                { id: 8, name: 'Project Work', startTime: '15:00', endTime: '17:30', category: 'work' },
                { id: 9, name: 'Commute Home', startTime: '17:30', endTime: '18:15', category: 'else' },
                { id: 10, name: 'Family Time', startTime: '18:15', endTime: '19:30', category: 'family' },
                { id: 11, name: 'Dinner', startTime: '19:30', endTime: '20:15', category: 'family' },
                { id: 12, name: 'Learning (Goal 1)', startTime: '20:15', endTime: '21:00', category: 'goal1' },
                { id: 13, name: 'Reading & Wind Down', startTime: '21:00', endTime: '22:30', category: 'myself' }
            ];

            // Example Off Day
            state.activities['Off Day'] = [
                { id: 101, name: 'Sleep In', startTime: '23:00', endTime: '08:00', category: 'myself' },
                { id: 102, name: 'Lazy Morning', startTime: '08:00', endTime: '09:30', category: 'myself' },
                { id: 103, name: 'Brunch', startTime: '09:30', endTime: '10:30', category: 'family' },
                { id: 104, name: 'Household Admin', startTime: '10:30', endTime: '12:00', category: 'admin' },
                { id: 105, name: 'Side Project (Goal 2)', startTime: '12:00', endTime: '14:00', category: 'goal2' },
                { id: 106, name: 'Outdoor Activity', startTime: '14:00', endTime: '17:00', category: 'family' },
                { id: 107, name: 'Relax & Hobbies', startTime: '17:00', endTime: '19:00', category: 'myself' },
                { id: 108, name: 'Dinner Out', startTime: '19:00', endTime: '21:00', category: 'family' },
                { id: 109, name: 'Movie Night', startTime: '21:00', endTime: '23:00', category: 'family' }
            ];

            // Example Holiday
            state.activities['Holiday'] = [
                { id: 201, name: 'Sleep', startTime: '00:00', endTime: '09:00', category: 'myself' },
                { id: 202, name: 'Breakfast', startTime: '09:00', endTime: '10:00', category: 'family' },
                { id: 203, name: 'Exploration', startTime: '10:00', endTime: '13:00', category: 'family' },
                { id: 204, name: 'Lunch', startTime: '13:00', endTime: '14:30', category: 'family' },
                { id: 205, name: 'Adventure Activity', startTime: '14:30', endTime: '18:00', category: 'family' },
                { id: 206, name: 'Rest & Freshen Up', startTime: '18:00', endTime: '19:30', category: 'myself' },
                { id: 207, name: 'Nice Dinner', startTime: '19:30', endTime: '22:00', category: 'family' },
                { id: 208, name: 'Evening Walk', startTime: '22:00', endTime: '23:00', category: 'myself' },
                { id: 209, name: 'Sleep', startTime: '23:00', endTime: '24:00', category: 'myself' }
            ];

            updateCategories();
        }

        function init() {
            initExampleData();
            renderDayTypeSelector();
            renderClocks();
            renderActivitiesList();
            renderLegend();
            renderSummaryStats();
            renderWeeklyView();
        }

        function timeToMinutes(time) {
            const [hours, minutes] = time.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToAngle(minutes, isPM = false) {
            const adjustedMinutes = isPM ? minutes - 720 : minutes;
            return (adjustedMinutes / 720) * 360;
        }

        function formatDuration(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (hours === 0) return `${mins}m`;
            if (mins === 0) return `${hours}h`;
            return `${hours}h ${mins}m`;
        }

        function getActivityColor(activity, index) {
            if (state.currentView === 'categories') {
                return getCategoryColor(activity.category);
            }
            // Use custom color if set, otherwise use category color
            if (activity.color) {
                return activity.color;
            }
            return getCategoryColor(activity.category);
        }

        function createArcPath(startAngle, endAngle, innerRadius, outerRadius, cx, cy) {
            const startAngleRad = (startAngle - 90) * Math.PI / 180;
            const endAngleRad = (endAngle - 90) * Math.PI / 180;
            const x1 = cx + outerRadius * Math.cos(startAngleRad);
            const y1 = cy + outerRadius * Math.sin(startAngleRad);
            const x2 = cx + outerRadius * Math.cos(endAngleRad);
            const y2 = cy + outerRadius * Math.sin(endAngleRad);
            const x3 = cx + innerRadius * Math.cos(endAngleRad);
            const y3 = cy + innerRadius * Math.sin(endAngleRad);
            const x4 = cx + innerRadius * Math.cos(startAngleRad);
            const y4 = cy + innerRadius * Math.sin(startAngleRad);
            const largeArc = endAngle - startAngle > 180 ? 1 : 0;
            return `M ${x1} ${y1} A ${outerRadius} ${outerRadius} 0 ${largeArc} 1 ${x2} ${y2} L ${x3} ${y3} A ${innerRadius} ${innerRadius} 0 ${largeArc} 0 ${x4} ${y4} Z`;
        }

        function setMainView(view) {
            state.currentMainView = view;
            // Cancel any editing in progress
            if (editingActivityId) cancelEdit();
            document.querySelectorAll('.main-view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mainview === view);
            });
            document.getElementById('dailyView').classList.toggle('active', view === 'daily');
            document.getElementById('weeklyView').classList.toggle('active', view === 'weekly');
            if (view === 'weekly') renderWeeklyView();
        }

        function renderClocks() {
            renderClock('clockAM', false);
            renderClock('clockPM', true);
        }

        function isOvernightActivity(activity) {
            const startMin = timeToMinutes(activity.startTime);
            const endMin = timeToMinutes(activity.endTime);
            return endMin < startMin || (endMin === startMin && activity.startTime !== activity.endTime);
        }

        function getActivitySegments(activity, isPM) {
            const startMin = timeToMinutes(activity.startTime);
            const endMin = timeToMinutes(activity.endTime);
            const isOvernight = isOvernightActivity(activity);
            const segments = [];
            
            if (isOvernight) {
                if (isPM) {
                    if (startMin >= 720) segments.push({ start: startMin, end: 1440 });
                } else {
                    if (endMin <= 720 && endMin > 0) segments.push({ start: 0, end: endMin });
                    if (startMin < 720) segments.push({ start: startMin, end: 720 });
                }
            } else {
                if (isPM) {
                    if (startMin < 1440 && endMin > 720) {
                        segments.push({ start: Math.max(startMin, 720), end: Math.min(endMin, 1440) });
                    }
                } else {
                    if (startMin < 720 && endMin > 0) {
                        segments.push({ start: Math.max(startMin, 0), end: Math.min(endMin, 720) });
                    }
                }
            }
            return segments.filter(s => s.start < s.end);
        }

        function renderClock(containerId, isPM) {
            const container = document.getElementById(containerId);
            const size = 320, cx = size / 2, cy = size / 2, outerRadius = 120, innerRadius = 45;
            let svg = `<svg viewBox="0 0 ${size} ${size}">`;
            
            // 1. Draw clock face background
            svg += `<circle cx="${cx}" cy="${cy}" r="${outerRadius}" class="clock-face"/>`;
            
            // 2. Draw activity arcs FIRST (so they're behind everything else)
            const activities = state.activities[state.currentDayType] || [];
            if (state.currentView === 'categories') {
                const categorySegments = {};
                activities.forEach(activity => {
                    getActivitySegments(activity, isPM).forEach(segment => {
                        if (!categorySegments[activity.category]) categorySegments[activity.category] = [];
                        categorySegments[activity.category].push({ ...segment, activity });
                    });
                });
                Object.entries(categorySegments).forEach(([cat, segments]) => {
                    segments.forEach(({ start, end, activity }) => {
                        const path = createArcPath(minutesToAngle(start, isPM), minutesToAngle(end, isPM), innerRadius, outerRadius, cx, cy);
                        svg += `<path d="${path}" fill="${getCategoryColor(cat)}" class="activity-arc" data-activity='${JSON.stringify(activity)}' onmouseenter="showTooltip(event)" onmouseleave="hideTooltip()" onmousemove="moveTooltip(event)"/>`;
                    });
                });
            } else {
                activities.forEach((activity, index) => {
                    const color = getActivityColor(activity, index);
                    getActivitySegments(activity, isPM).forEach(segment => {
                        const path = createArcPath(minutesToAngle(segment.start, isPM), minutesToAngle(segment.end, isPM), innerRadius, outerRadius, cx, cy);
                        svg += `<path d="${path}" fill="${color}" class="activity-arc" data-activity='${JSON.stringify(activity)}' onmouseenter="showTooltip(event)" onmouseleave="hideTooltip()" onmousemove="moveTooltip(event)"/>`;
                    });
                });
            }
            
            // 3. Draw center circle (on top of arcs)
            svg += `<circle cx="${cx}" cy="${cy}" r="${innerRadius}" class="clock-center"/>`;

            // 4. Draw hour markers and labels ON TOP of everything
            for (let i = 0; i < 12; i++) {
                const angle = (i * 30 - 90) * Math.PI / 180;
                const isMajor = i % 3 === 0; // 0, 3, 6, 9 positions
                
                // Draw tick marks from edge inward
                const markerOuter = outerRadius;
                const markerInner = outerRadius - (isMajor ? 10 : 6);
                const x1 = cx + markerOuter * Math.cos(angle);
                const y1 = cy + markerOuter * Math.sin(angle);
                const x2 = cx + markerInner * Math.cos(angle);
                const y2 = cy + markerInner * Math.sin(angle);
                svg += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="${isMajor ? '#8b7355' : '#d4b8a0'}" stroke-width="${isMajor ? 3 : 2}"/>`;
                
                // Only show labels for major hours - positioned OUTSIDE the clock
                if (isMajor) {
                    const labelRadius = outerRadius + 20;
                    const lx = cx + labelRadius * Math.cos(angle);
                    const ly = cy + labelRadius * Math.sin(angle);
                    const hour = isPM ? i + 12 : i;
                    svg += `<text x="${lx}" y="${ly}" text-anchor="middle" dominant-baseline="middle" style="font-size: 15px; font-weight: 600; fill: #4a3728;">${hour}</text>`;
                }
            }

            svg += '</svg>';
            container.innerHTML = svg;
        }

        function renderWeeklyView() {
            const grid = document.getElementById('weeklyGrid');
            let html = '<div class="time-column"><div class="time-column-header">Time</div>';
            for (let h = 0; h < 24; h++) html += `<div class="time-slot">${h.toString().padStart(2, '0')}:00</div>`;
            html += '</div>';

            weekDays.forEach((day, dayIndex) => {
                const isWeekend = dayIndex >= 5;
                const dayType = state.weekAssignments[day];
                const activities = state.activities[dayType] || [];

                html += `<div class="day-column ${isWeekend ? 'weekend' : ''}">`;
                html += `<div class="day-column-header"><div class="day-name">${day}</div>`;
                html += `<select class="day-type-select" onchange="setWeekDayType('${day}', this.value)">`;
                state.dayTypes.forEach(type => html += `<option value="${type}" ${type === dayType ? 'selected' : ''}>${type}</option>`);
                html += '</select></div><div class="day-slots">';

                for (let h = 0; h < 24; h++) {
                    html += `<div class="hour-line" style="top: ${h * 40}px;"></div>`;
                    html += `<div class="half-hour-line" style="top: ${h * 40 + 20}px;"></div>`;
                }

                activities.forEach(activity => {
                    getWeeklyActivitySegments(activity).forEach(segment => {
                        const top = (segment.start / 60) * 40;
                        const height = Math.max(((segment.end - segment.start) / 60) * 40, 20);
                        html += `<div class="weekly-activity" style="top: ${top}px; height: ${height}px; background: ${getCategoryColor(activity.category)};" data-activity='${JSON.stringify(activity)}' data-day="${day}" onmouseenter="showWeeklyTooltip(event)" onmouseleave="hideTooltip()" onmousemove="moveTooltip(event)">`;
                        html += `<div class="weekly-activity-name">${activity.name}</div>`;
                        if (height > 25) html += `<div class="weekly-activity-time">${activity.startTime} - ${activity.endTime}</div>`;
                        html += '</div>';
                    });
                });
                html += '</div></div>';
            });

            grid.innerHTML = html;
            renderWeeklyLegend();
            renderWeeklyStats();
        }

        function getWeeklyActivitySegments(activity) {
            const startMin = timeToMinutes(activity.startTime);
            const endMin = timeToMinutes(activity.endTime);
            if (isOvernightActivity(activity)) {
                const segments = [{ start: startMin, end: 1440 }];
                if (endMin > 0) segments.push({ start: 0, end: endMin });
                return segments;
            }
            return [{ start: startMin, end: endMin }];
        }

        function setWeekDayType(day, dayType) {
            state.weekAssignments[day] = dayType;
            renderWeeklyView();
            saveToStorage();
        }

        function renderWeeklyLegend() {
            document.getElementById('weeklyLegend').innerHTML = Object.entries(categories).map(([key, value]) =>
                `<div class="legend-item"><div class="legend-color" style="background: ${value.color}"></div><span>${value.label}</span></div>`
            ).join('');
        }

        function renderWeeklyStats() {
            const weeklyTotals = {};
            Object.keys(categories).forEach(cat => weeklyTotals[cat] = 0);

            weekDays.forEach(day => {
                const activities = state.activities[state.weekAssignments[day]] || [];
                activities.forEach(activity => {
                    let duration = timeToMinutes(activity.endTime) - timeToMinutes(activity.startTime);
                    if (duration < 0) duration += 1440;
                    weeklyTotals[activity.category] += duration;
                });
            });

            const totalWeekly = Object.values(weeklyTotals).reduce((a, b) => a + b, 0);
            const totalWeekHours = 7 * 24 * 60;

            document.getElementById('weeklyStats').innerHTML = `
                <div class="weekly-stat-item"><div class="weekly-stat-value">${formatDuration(totalWeekly)}</div><div class="weekly-stat-label">Total Planned</div></div>
                <div class="weekly-stat-item"><div class="weekly-stat-value">${formatDuration(totalWeekHours - totalWeekly)}</div><div class="weekly-stat-label">Unplanned</div></div>
                ${Object.entries(categories).filter(([key]) => weeklyTotals[key] > 0).map(([key, value]) =>
                    `<div class="weekly-stat-item"><div class="weekly-stat-value" style="color: ${value.color}">${formatDuration(weeklyTotals[key])}</div><div class="weekly-stat-label">${value.label}</div></div>`
                ).join('')}
            `;
        }

        function showWeeklyTooltip(event) {
            const el = event.target.closest('.weekly-activity');
            const activity = JSON.parse(el.dataset.activity);
            const day = el.dataset.day;
            let duration = timeToMinutes(activity.endTime) - timeToMinutes(activity.startTime);
            if (duration < 0) duration += 1440;
            document.getElementById('tooltip').innerHTML = `
                <div class="tooltip-name">${activity.name}</div>
                <div class="tooltip-time">${activity.startTime} - ${activity.endTime} (${formatDuration(duration)})</div>
                <span class="tooltip-category" style="background: ${getCategoryColor(activity.category)}20; color: ${getCategoryColor(activity.category)}">${categoryLabels[activity.category]}</span>
                <div class="tooltip-day">${day}  ${state.weekAssignments[day]}</div>
            `;
            document.getElementById('tooltip').style.display = 'block';
            moveTooltip(event);
        }

        function showTooltip(event) {
            const activity = JSON.parse(event.target.dataset.activity);
            let duration = timeToMinutes(activity.endTime) - timeToMinutes(activity.startTime);
            if (duration < 0) duration += 1440;
            document.getElementById('tooltip').innerHTML = `
                <div class="tooltip-name">${activity.name}</div>
                <div class="tooltip-time">${activity.startTime} - ${activity.endTime} (${formatDuration(duration)})</div>
                <span class="tooltip-category" style="background: ${getCategoryColor(activity.category)}20; color: ${getCategoryColor(activity.category)}">${categoryLabels[activity.category]}</span>
            `;
            document.getElementById('tooltip').style.display = 'block';
            moveTooltip(event);
        }

        function moveTooltip(event) {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.left = event.pageX + 15 + 'px';
            tooltip.style.top = event.pageY + 15 + 'px';
        }

        function hideTooltip() { document.getElementById('tooltip').style.display = 'none'; }

        function renderDayTypeSelector() {
            document.getElementById('dayTypeSelector').innerHTML = state.dayTypes.map(type =>
                `<button class="day-type-btn ${type === state.currentDayType ? 'active' : ''}" onclick="selectDayType('${type}')">${type}</button>`
            ).join('');
        }

        function selectDayType(type) {
            state.currentDayType = type;
            // Cancel any editing in progress
            if (editingActivityId) cancelEdit();
            renderDayTypeSelector();
            renderClocks();
            renderActivitiesList();
            renderSummaryStats();
        }

        function setView(view) {
            state.currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.view === view));
            renderClocks();
            renderLegend();
        }

        let editingActivityId = null;

        function renderActivitiesList() {
            const activities = state.activities[state.currentDayType] || [];
            if (activities.length === 0) {
                document.getElementById('activitiesList').innerHTML = `<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg><p>No activities yet</p></div>`;
                return;
            }
            document.getElementById('activitiesList').innerHTML = activities.map((activity, index) => `
                <div class="activity-item ${editingActivityId === activity.id ? 'editing' : ''}">
                    <div class="activity-color" style="background: ${state.currentView === 'categories' ? getCategoryColor(activity.category) : getActivityColor(activity, index)}"></div>
                    <div class="activity-info">
                        <div class="activity-name">${activity.name}</div>
                        <div class="activity-time">${activity.startTime} - ${activity.endTime}  ${categoryLabels[activity.category]}</div>
                    </div>
                    <div class="activity-actions">
                        <button class="edit" onclick="editActivity(${activity.id})" title="Edit">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                        </button>
                        <button class="delete" onclick="deleteActivity(${activity.id})" title="Delete">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function editActivity(id) {
            const activity = state.activities[state.currentDayType].find(a => a.id === id);
            if (!activity) return;
            
            editingActivityId = id;
            
            // Populate form with activity data
            document.getElementById('activityName').value = activity.name;
            document.getElementById('startTime').value = activity.startTime;
            document.getElementById('endTime').value = activity.endTime;
            document.getElementById('category').value = activity.category;
            
            // Set color (custom or category default)
            document.getElementById('activityColor').value = activity.color || getCategoryColor(activity.category);
            
            // Update button text and show cancel button
            document.getElementById('submitBtn').innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                    <path d="M17 21v-8H7v8M7 3v5h8"/>
                </svg>
                Update Activity
            `;
            document.getElementById('cancelEditBtn').style.display = 'block';
            
            // Highlight the editing item
            renderActivitiesList();
            
            // Scroll form into view
            document.getElementById('activityForm').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function cancelEdit() {
            editingActivityId = null;
            document.getElementById('activityForm').reset();
            document.getElementById('activityColor').value = getCategoryColor('work');
            document.getElementById('submitBtn').innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
                Add Activity
            `;
            document.getElementById('cancelEditBtn').style.display = 'none';
            renderActivitiesList();
        }

        function addActivity(event) {
            event.preventDefault();

            const name = document.getElementById('activityName').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const category = document.getElementById('category').value;
            const selectedColor = document.getElementById('activityColor').value;
            const categoryColor = getCategoryColor(category);
            // Auto-detect: if color differs from category color, it's custom
            const customColor = (selectedColor.toLowerCase() !== categoryColor.toLowerCase()) ? selectedColor : null;

            if (!state.activities[state.currentDayType]) state.activities[state.currentDayType] = [];

            if (editingActivityId) {
                // Update existing activity
                const activityIndex = state.activities[state.currentDayType].findIndex(a => a.id === editingActivityId);
                if (activityIndex !== -1) {
                    state.activities[state.currentDayType][activityIndex] = {
                        id: editingActivityId,
                        name,
                        startTime,
                        endTime,
                        category,
                        color: customColor
                    };
                }
                editingActivityId = null;
                document.getElementById('submitBtn').innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                    Add Activity
                `;
                document.getElementById('cancelEditBtn').style.display = 'none';
            } else {
                // Add new activity
                state.activities[state.currentDayType].push({
                    id: Date.now(),
                    name,
                    startTime,
                    endTime,
                    category,
                    color: customColor
                });
            }

            state.activities[state.currentDayType].sort((a, b) => timeToMinutes(a.startTime) - timeToMinutes(b.startTime));
            document.getElementById('activityForm').reset();
            document.getElementById('activityColor').value = getCategoryColor('work');
            renderClocks(); renderActivitiesList(); renderSummaryStats(); renderWeeklyView(); saveToStorage();
        }

        function deleteActivity(id) {
            state.activities[state.currentDayType] = state.activities[state.currentDayType].filter(a => a.id !== id);
            renderClocks(); renderActivitiesList(); renderSummaryStats(); renderWeeklyView(); saveToStorage();
        }


        function renderLegend() {
            if (state.currentView === 'categories') {
                document.getElementById('legend').innerHTML = Object.entries(categories).map(([key, value]) =>
                    `<div class="legend-item"><div class="legend-color" style="background: ${value.color}"></div><span>${value.label}</span></div>`
                ).join('');
            } else {
                const activities = state.activities[state.currentDayType] || [];
                document.getElementById('legend').innerHTML = activities.map((activity, index) =>
                    `<div class="legend-item"><div class="legend-color" style="background: ${getActivityColor(activity, index)}"></div><span>${activity.name}</span></div>`
                ).join('');
            }
        }

        function renderSummaryStats() {
            const activities = state.activities[state.currentDayType] || [];
            const categoryMinutes = {};
            Object.keys(categories).forEach(cat => categoryMinutes[cat] = 0);
            activities.forEach(activity => {
                let duration = timeToMinutes(activity.endTime) - timeToMinutes(activity.startTime);
                if (duration < 0) duration += 1440;
                categoryMinutes[activity.category] += duration;
            });
            const totalPlanned = Object.values(categoryMinutes).reduce((a, b) => a + b, 0);
            document.getElementById('summaryStats').innerHTML = `
                <div class="stat-item"><div class="stat-value">${formatDuration(totalPlanned)}</div><div class="stat-label">Planned</div></div>
                <div class="stat-item"><div class="stat-value">${formatDuration(Math.max(0, 1440 - totalPlanned))}</div><div class="stat-label">Unplanned</div></div>
                ${Object.entries(categories).filter(([key]) => categoryMinutes[key] > 0).map(([key, value]) =>
                    `<div class="stat-item"><div class="stat-value" style="color: ${value.color}">${formatDuration(categoryMinutes[key])}</div><div class="stat-label">${value.label}</div></div>`
                ).join('')}
            `;
        }

        function openDayTypeModal() { document.getElementById('dayTypeModal').classList.add('active'); renderDayTypeList(); }
        function closeDayTypeModal() { document.getElementById('dayTypeModal').classList.remove('active'); }

        function openCategoryColorsModal() { 
            document.getElementById('categoryColorsModal').classList.add('active'); 
            renderCategoryColorsList(); 
        }
        function closeCategoryColorsModal() { 
            document.getElementById('categoryColorsModal').classList.remove('active'); 
        }

        function renderCategoryColorsList() {
            const container = document.getElementById('categoryColorsList');
            container.innerHTML = Object.keys(categoryLabels).map(key => `
                <div class="category-color-item">
                    <input type="color" value="${getCategoryColor(key)}" onchange="updateCategoryColor('${key}', this.value)">
                    <span>${categoryLabels[key]}</span>
                </div>
            `).join('');
        }

        function updateCategoryColor(category, color) {
            state.categoryColors[category] = color;
            updateCategories();
            saveToStorage();
            renderClocks();
            renderActivitiesList();
            renderLegend();
            renderSummaryStats();
            if (state.currentMainView === 'weekly') renderWeeklyView();
        }

        function resetCategoryColors() {
            state.categoryColors = { ...defaultCategoryColors };
            updateCategories();
            renderCategoryColorsList();
            saveToStorage();
            renderClocks();
            renderActivitiesList();
            renderLegend();
            renderSummaryStats();
            if (state.currentMainView === 'weekly') renderWeeklyView();
        }

        function updateColorFromCategory() {
            const category = document.getElementById('category').value;
            document.getElementById('activityColor').value = getCategoryColor(category);
        }

        function resetToCategory() {
            const category = document.getElementById('category').value;
            document.getElementById('activityColor').value = getCategoryColor(category);
        }

        function renderDayTypeList() {
            document.getElementById('dayTypeList').innerHTML = state.dayTypes.map(type => `
                <div class="day-type-item"><span>${type}</span>
                    ${state.dayTypes.length > 1 ? `<button class="btn btn-danger btn-sm" onclick="removeDayType('${type}')"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>` : ''}
                </div>
            `).join('');
        }

        function addDayType() {
            const name = document.getElementById('newDayTypeName').value.trim();
            if (name && !state.dayTypes.includes(name)) {
                state.dayTypes.push(name);
                state.activities[name] = [];
                document.getElementById('newDayTypeName').value = '';
                renderDayTypeList(); renderDayTypeSelector(); renderWeeklyView(); saveToStorage();
            }
        }

        function removeDayType(type) {
            if (state.dayTypes.length > 1) {
                state.dayTypes = state.dayTypes.filter(t => t !== type);
                delete state.activities[type];
                weekDays.forEach(day => { if (state.weekAssignments[day] === type) state.weekAssignments[day] = state.dayTypes[0]; });
                if (state.currentDayType === type) state.currentDayType = state.dayTypes[0];
                renderDayTypeList(); renderDayTypeSelector(); renderClocks(); renderActivitiesList(); renderSummaryStats(); renderWeeklyView(); saveToStorage();
            }
        }

        function saveToStorage() { localStorage.setItem('dailyPlannerStateLight', JSON.stringify(state)); }

        function exportData() {
            const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `daily-planner-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        state = JSON.parse(e.target.result);
                        if (!state.weekAssignments) state.weekAssignments = { 'Monday': 'Work Day', 'Tuesday': 'Work Day', 'Wednesday': 'Work Day', 'Thursday': 'Work Day', 'Friday': 'Work Day', 'Saturday': 'Off Day', 'Sunday': 'Off Day' };
                        saveToStorage(); init();
                    } catch (err) { alert('Invalid file format'); }
                };
                reader.readAsText(file);
            }
        }

        function clearCurrentDay() {
            if (confirm(`Clear all activities for "${state.currentDayType}"?`)) {
                state.activities[state.currentDayType] = [];
                renderClocks(); renderActivitiesList(); renderSummaryStats(); renderWeeklyView(); saveToStorage();
            }
        }

        function loadExampleData() {
            if (!confirm('This will replace all current data with example data. Continue?')) return;
            
            // Reset state
            state.dayTypes = ['Work Day', 'Off Day', 'Holiday'];
            state.currentDayType = 'Work Day';
            state.categoryColors = { ...defaultCategoryColors };
            state.weekAssignments = {
                'Monday': 'Work Day', 'Tuesday': 'Work Day', 'Wednesday': 'Work Day',
                'Thursday': 'Work Day', 'Friday': 'Work Day', 'Saturday': 'Off Day', 'Sunday': 'Off Day'
            };

            // Example Work Day
            state.activities['Work Day'] = [
                { id: 1, name: 'Sleep', startTime: '22:30', endTime: '06:30', category: 'myself' },
                { id: 2, name: 'Morning Routine', startTime: '06:30', endTime: '07:15', category: 'myself' },
                { id: 3, name: 'Breakfast with Family', startTime: '07:15', endTime: '07:45', category: 'family' },
                { id: 4, name: 'Commute', startTime: '07:45', endTime: '08:30', category: 'else' },
                { id: 5, name: 'Deep Work Block', startTime: '08:30', endTime: '12:00', category: 'work' },
                { id: 6, name: 'Lunch Break', startTime: '12:00', endTime: '13:00', category: 'myself' },
                { id: 7, name: 'Meetings & Collaboration', startTime: '13:00', endTime: '15:00', category: 'work' },
                { id: 8, name: 'Project Work', startTime: '15:00', endTime: '17:30', category: 'work' },
                { id: 9, name: 'Commute Home', startTime: '17:30', endTime: '18:15', category: 'else' },
                { id: 10, name: 'Family Time', startTime: '18:15', endTime: '19:30', category: 'family' },
                { id: 11, name: 'Dinner', startTime: '19:30', endTime: '20:15', category: 'family' },
                { id: 12, name: 'Learning (Goal 1)', startTime: '20:15', endTime: '21:00', category: 'goal1' },
                { id: 13, name: 'Reading & Wind Down', startTime: '21:00', endTime: '22:30', category: 'myself' }
            ];

            // Example Off Day
            state.activities['Off Day'] = [
                { id: 101, name: 'Sleep In', startTime: '23:00', endTime: '08:00', category: 'myself' },
                { id: 102, name: 'Lazy Morning', startTime: '08:00', endTime: '09:30', category: 'myself' },
                { id: 103, name: 'Brunch', startTime: '09:30', endTime: '10:30', category: 'family' },
                { id: 104, name: 'Household Admin', startTime: '10:30', endTime: '12:00', category: 'admin' },
                { id: 105, name: 'Side Project (Goal 2)', startTime: '12:00', endTime: '14:00', category: 'goal2' },
                { id: 106, name: 'Outdoor Activity', startTime: '14:00', endTime: '17:00', category: 'family' },
                { id: 107, name: 'Relax & Hobbies', startTime: '17:00', endTime: '19:00', category: 'myself' },
                { id: 108, name: 'Dinner Out', startTime: '19:00', endTime: '21:00', category: 'family' },
                { id: 109, name: 'Movie Night', startTime: '21:00', endTime: '23:00', category: 'family' }
            ];

            // Example Holiday
            state.activities['Holiday'] = [
                { id: 201, name: 'Sleep', startTime: '00:00', endTime: '09:00', category: 'myself' },
                { id: 202, name: 'Breakfast', startTime: '09:00', endTime: '10:00', category: 'family' },
                { id: 203, name: 'Exploration', startTime: '10:00', endTime: '13:00', category: 'family' },
                { id: 204, name: 'Lunch', startTime: '13:00', endTime: '14:30', category: 'family' },
                { id: 205, name: 'Adventure Activity', startTime: '14:30', endTime: '18:00', category: 'family' },
                { id: 206, name: 'Rest & Freshen Up', startTime: '18:00', endTime: '19:30', category: 'myself' },
                { id: 207, name: 'Nice Dinner', startTime: '19:30', endTime: '22:00', category: 'family' },
                { id: 208, name: 'Evening Walk', startTime: '22:00', endTime: '23:00', category: 'myself' },
                { id: 209, name: 'Sleep', startTime: '23:00', endTime: '24:00', category: 'myself' }
            ];

            updateCategories();
            saveToStorage();
            renderDayTypeSelector();
            renderClocks();
            renderActivitiesList();
            renderLegend();
            renderSummaryStats();
            renderWeeklyView();
        }

        init();
        document.getElementById('dayTypeModal').addEventListener('click', (e) => { if (e.target.classList.contains('modal-overlay')) closeDayTypeModal(); });
        document.getElementById('categoryColorsModal').addEventListener('click', (e) => { if (e.target.classList.contains('modal-overlay')) closeCategoryColorsModal(); });

        // ==================== CHARTS ====================
        let areaChart = null;
        let donutChart = null;
        let barChart = null;

        function renderCharts() {
            renderAreaChart();
            renderDonutChart();
            renderBarChart();
        }

        function getWeeklyDataByDay() {
            const data = {};
            Object.keys(categories).forEach(cat => data[cat] = []);
            
            weekDays.forEach(day => {
                const dayType = state.weekAssignments[day];
                const acts = state.activities[dayType] || [];
                const dayTotals = {};
                Object.keys(categories).forEach(cat => dayTotals[cat] = 0);
                
                acts.forEach(activity => {
                    let duration = timeToMinutes(activity.endTime) - timeToMinutes(activity.startTime);
                    if (duration < 0) duration += 1440;
                    dayTotals[activity.category] += duration;
                });
                
                Object.keys(categories).forEach(cat => {
                    data[cat].push(dayTotals[cat] / 60); // Convert to hours
                });
            });
            
            return data;
        }

        function getWeeklyTotals() {
            const totals = {};
            Object.keys(categories).forEach(cat => totals[cat] = 0);
            
            weekDays.forEach(day => {
                const dayType = state.weekAssignments[day];
                const acts = state.activities[dayType] || [];
                acts.forEach(activity => {
                    let duration = timeToMinutes(activity.endTime) - timeToMinutes(activity.startTime);
                    if (duration < 0) duration += 1440;
                    totals[activity.category] += duration;
                });
            });
            
            return totals;
        }

        function getDayTypeTotals() {
            const result = {};
            state.dayTypes.forEach(dayType => {
                result[dayType] = {};
                Object.keys(categories).forEach(cat => result[dayType][cat] = 0);
                
                const acts = state.activities[dayType] || [];
                acts.forEach(activity => {
                    let duration = timeToMinutes(activity.endTime) - timeToMinutes(activity.startTime);
                    if (duration < 0) duration += 1440;
                    result[dayType][activity.category] += duration;
                });
            });
            return result;
        }

        function renderAreaChart() {
            const ctx = document.getElementById('areaChart');
            if (!ctx) return;
            
            if (areaChart) areaChart.destroy();
            
            const weeklyData = getWeeklyDataByDay();
            const datasets = Object.entries(categories)
                .filter(([key]) => weeklyData[key].some(v => v > 0))
                .map(([key, value]) => ({
                    label: value.label,
                    data: weeklyData[key],
                    backgroundColor: value.color + '80',
                    borderColor: value.color,
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: value.color
                }));

            areaChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weekDays.map(d => d.substring(0, 3)),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw.toFixed(1)}h`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(139, 115, 85, 0.1)' }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            max: 24,
                            title: { display: true, text: 'Hours', font: { size: 11 } },
                            grid: { color: 'rgba(139, 115, 85, 0.1)' }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function renderDonutChart() {
            const ctx = document.getElementById('donutChart');
            if (!ctx) return;
            
            if (donutChart) donutChart.destroy();
            
            const totals = getWeeklyTotals();
            const filteredData = Object.entries(categories)
                .filter(([key]) => totals[key] > 0)
                .map(([key, value]) => ({
                    label: value.label,
                    value: totals[key] / 60,
                    color: value.color
                }));

            donutChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: filteredData.map(d => d.label),
                    datasets: [{
                        data: filteredData.map(d => d.value),
                        backgroundColor: filteredData.map(d => d.color),
                        borderColor: '#fff8f0',
                        borderWidth: 3,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '55%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 12,
                                font: { size: 10 },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => ({
                                        text: `${label}: ${data.datasets[0].data[i].toFixed(1)}h`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: data.datasets[0].backgroundColor[i],
                                        pointStyle: 'circle',
                                        index: i
                                    }));
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.raw.toFixed(1)}h (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderBarChart() {
            const ctx = document.getElementById('barChart');
            if (!ctx) return;
            
            if (barChart) barChart.destroy();
            
            const dayTypeTotals = getDayTypeTotals();
            const dayTypeLabels = state.dayTypes;
            
            const datasets = Object.entries(categories)
                .filter(([key]) => {
                    return dayTypeLabels.some(dt => dayTypeTotals[dt][key] > 0);
                })
                .map(([key, value]) => ({
                    label: value.label,
                    data: dayTypeLabels.map(dt => dayTypeTotals[dt][key] / 60),
                    backgroundColor: value.color + 'CC',
                    borderColor: value.color,
                    borderWidth: 1,
                    borderRadius: 4
                }));

            barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dayTypeLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw.toFixed(1)}h`;
                                },
                                footer: function(tooltipItems) {
                                    const total = tooltipItems.reduce((sum, item) => sum + item.raw, 0);
                                    return `Total: ${total.toFixed(1)}h`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            grid: { display: false }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            max: 24,
                            title: { display: true, text: 'Hours per Day', font: { size: 11 } },
                            grid: { color: 'rgba(139, 115, 85, 0.1)' }
                        }
                    }
                }
            });
        }

        // Update renderWeeklyView to also render charts
        const originalRenderWeeklyView = renderWeeklyView;
        renderWeeklyView = function() {
            originalRenderWeeklyView();
            setTimeout(renderCharts, 100);
        };
    </script>
</body>
</html>
